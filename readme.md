# ReportConstructorService

## Общее

**ReportConstructorService** - сервис построения отчётов. 


## Инфраструктура

### Базы данных

Сервис напрямую использует две БД:
1) ReportOrdersDb - база данных, в которой хранится информация о статусе
заказа отчёта. База данных обновляется автоматически через миграции.
2) ReportsDb - база из старого ReportsConstructorService, нужна только для 
таблички UserActions и одной хранимой процедуры, в планах выпилить эту БД.

Остальные базы, которые указываются в конфигурации и которых нет в этом списке,
используется в хранимых процедурах для межсерверных запросов.

### Другие сервисы

Для полноценной работы сервиса требуется настроить подключение к:
1) RabbitMQ в RabbitMqOptions.
2) Rest api портала в WebServiceRestOptions.

## Принцип работы

Когда в сервис приходит запрос на создание отчёта, сервис создаёт запись
о поступившем заказе в БД ReportOrdersDb, затем отправляется команда
на создание отчёта в кролик, после чего пользователю возвращается id 
заказа отчёта.


В проекте Report.Constructor.Infrastructure определён консьюмер, занимающийся
обработкой сообщений на создание отчёта. Получив такое сообщение, консьюмер 
меняет статус заказа в БД ReportOrdersDb и строит отчёт заданного типа.


## Архитектура солюшена

Сервис состоит из нескольких проектов:
1) Report.Constructor.Gateway - входная точка в сервис. 
2) Report.Constructor.Core - проект, содержащий основные типы, не привязанные 
ни к какой определённой технологии и использующиеся по всему солюшену.
3) Report.Constructor.DAL - слой доступа к каким-лобо данным. В нём реализованы все репозитории.
4) Report.Constructor.Application - проект, поставляющий интерфейсы для Gateway.
Некий слой абстракции, скрывающий технические подробности реализации его членов.
Также может содержать в себе модели, которые более близки к бизнес логике, 
чем модели в Core.
5) Report.Constructor.Infrastructure - проект, в котором находится реализация 
всех интерфейсов проекта Application. Слой оперирует интерфейсами, предоставленными DAL.
6) WebServiceRestAdapter - адаптер Rest api портала Москвы.


## Как добавить новый отчёт

Чтобы добавить новый отчёт, достаточно просто определить новый класс 
в проекте Infrastructure, реализующий интерфейс IReportDataGetter. В поле
CompatibleReportType указать необходимый тип отчёта и имплементировать
логику получения данных для отчёта в методе GetReportData.


В случае, если отчёт формируется на основе данных, полученных через
хранимые процедуры, помимо реализации IReportDataGetter требуется также
в проекте DAL добавить скрипт отчёта и определить все новые синонимы, если такие присутствуют.